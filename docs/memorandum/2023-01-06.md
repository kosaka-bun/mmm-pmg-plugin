# 开发备忘 - 2023-01-06

## 前言
很显然，项目在生成自然动作这一块遇到了瓶颈。在现有技术框架下进行的所有思考，尝试过的各种解决方案，均不能解决这一问题。

现目前我们面临的问题主要有：
1. 固定状态的手型问题。即使不考虑手的动态动作，仅仅只是生成手在演奏某个音符时的固定动作时，都不能够生成一个自然的手型。
2. 由我们计算出的指法等数据并不可视，且结构较为混乱。
3. 经过多次尝试，仍未确定一个合适可行的算法去计算演奏某个音时的手型。
4. MikuMikuMoving为插件开发提供的诸多API并不齐全，譬如无法获取某个可移动骨骼的绝对坐标。这使得位置计算变得十分困难。

所以，我们或许应该考虑重新对这个项目进行构造了，理由如下：
1. 当前工程的代码管理十分混乱，各类组件功能模糊不清，没有良好的组织性。
2. 我们不应当过度依赖原插件生成的csv文件，而应当自行对MIDI文件进行解析。否则每次生成一首音乐前都必须运行原插件。
3. 对MIDI文件解析后生成的数据文件中，绝不应当只包含音符开始帧、结束帧以及指法，更应该对手型、手腕位置等数据进行计算，且这些内容也并不应该在C#语言下完成。
4. C#层应仅读取数据文件，以及生成动作，此外不做其他任何事情。

## 回顾运行原理
插件是按照以下顺序运行的（以PianoPlayingMotionGenerator目录为相对根目录）：
1. 插件在MMM上的图标被点击后，`CommandPluginImpl.Run()`被调用，然后调用`Program.showDialog()`。
2. 窗口显示完毕，`MainForm.Form1_Load()`被调用，`Program.loadData()`被调用，`Hand`类的构造方法被调用，读取MMM中当前选择的模型的左右手的关键帧数据。至此，初始化完成。
3. 用户选择左右手要使用的音符指法文件，点击执行后，`Program.execute()`被调用，`Program.execute(string path, Hand hand)`被调用。
4. 插件内的指法计算器读取文件中的内容，为音符计算指法。随后依次调用`Hand.play(Note note)`方法，逐次计算每个音符的手型与骨骼位置，并注册关键帧。

插件计算手型和骨骼位置的基本逻辑为：
1. 抬起所有手指，并在音符弹下前一帧注册关键帧。
2. 先将被用到的手指移动到指定的音符处，然后调整**未被用到**的手指所在的位置以及手腕的位置，然后弹下被用到的手指，最后在弹下音符的那一帧注册关键帧。
3. 抬起所有手指，并在音符结束那一帧注册关键帧。

可以看出，目前程序的逻辑仅为计算演奏每个音符时的固定的手型。手在未演奏音符时是不会动的，如果需要演奏音符，则会瞬移到相应的音符处，然后瞬间摆好手型，弹下，然后再缓慢抬起。

插件目前在`ArrangeFingerAlgorithm.doArrange()`方法处暂停了编写，该方法用于在手指移动到相应的音符处过后，计算所有**未被用到**的手指应该处于的位置。

## 后续思路
目前，针对`ArrangeFingerAlgorithm.doArrange()`方法的实现，我们并没有很好的思路。如果完全不考虑其他所有手指在演奏前的位置，则必然会造成大量不必要的手指移动，这并不是一个自然的动作。

我们计划在后续的开发中，另开一个独立的项目，用于解析MIDI和生成指法。此外，我们不仅仅需要计算指法，还应该综合考虑各类因素，计算手腕的位置和其他所有手指的位置，并在一定程度上对具有一定结构的音型（如分解和弦）进行分析，提前确定手型与手的把位。

然后，新的动作生成插件不再进行任何形式的指法与手型计算，完全依据上述项目的生成结果，进行动作的生成。